.PHONY: help create-cluster delete-cluster

help: ## Show this help message
	@echo 'Usage: make [target]'
	@echo ''
	@echo 'Targets:'
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "  %-20s %s\n", $$1, $$2}' $(MAKEFILE_LIST)

create-cluster: ## Create a local Kubernetes cluster
	kind create cluster --config config/kind.yaml

delete-cluster: ## Delete the local Kubernetes cluster
	kind delete cluster --name homelab

metal:
	make -C metal

system:
	make -C system

external:
	make -C external

smoke-test:
	make -C test filter=Smoke

post-install:
	@./scripts/hacks

# TODO maybe there's a better way to manage backup with GitOps?
backup:
	./scripts/backup --action setup --namespace=actualbudget --pvc=actualbudget-data
	./scripts/backup --action setup --namespace=jellyfin --pvc=jellyfin-data

restore:
	./scripts/backup --action restore --namespace=actualbudget --pvc=actualbudget-data
	./scripts/backup --action restore --namespace=jellyfin --pvc=jellyfin-data

test:
	make -C test

clean:
	docker compose --project-directory ./metal/roles/pxe_server/files down
	k3d cluster delete homelab-dev

docs:
	mkdocs serve

git-hooks:
	pre-commit install

status: ## Check cluster status
	kubectl cluster-info
	kubectl get nodes
	kubectl get pods -A
